@using fletnix.ViewModels
@{
    ViewData["Title"] = "Home Page";
    Layout = "_Layout";
}

<div class="container-fluid" style="margin-top: 50px;">
    <h2 style="color: #8E8E8E;  font-size: 18px; font-family: arial;">Your Watch history</h2>
    <div class="row">
        @foreach (var history in (List<PopularMoviesViewModel>) Model)
        {
            <div class="col-md-2" style="padding: 5px;">
                <div style="overflow: hidden; height: 200px; margin-bottom: 0px;">
                    <div class="movie watchhistory-movie" style="position: relative; min-height: 170px; color: white; text-align: center;" data-id="@history.Movie.MovieId" data-title="@history.Movie.Title">
                        <div style="background-color: #141414; padding: 5px; padding-top: 11px; position: absolute; z-index: 99; height: 48px; width: 102%; font-size: 16px; top: 150px; color: #8E8E8E;">@history.Movie.Title</div>
                        <img class="movie-poster-@history.Movie.MovieId" src="~/images/no-backdrop.jpg" style="width: 100%;"/>
                        <div data-title="@history.Movie.Title" data-id="@history.Movie.MovieId" data-year="@history.Movie.PublicationYear" style="position: absolute; top: 107px; left: 3px; z-index: 999; padding: 10px; color: white;" class="feedback-box">Leave feedback <i class="fa fa-commenting" aria-hidden="true"></i></div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>


<div class="modal fade" id="feedbackmodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg"  role="document">
        <div class="modal-content" style="background-color: #141414;">
            <div class="modal-header" style="border-bottom: 1px solid #8E8E8E;">
                <button type="button" class="close" style="color: white;"  data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="mtitlefeedback" style="color: white;" id="myModalLabel">We appreciate you giving us feedback!</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                       
                        <img id="feedbackposterimage" style="margin-top: 10px; width: 100%;"></img>

                    </div>
                    <div class="col-md-9">
                        <label style="color: white;">What did you think of it?</label><br>
                        <textarea style="color: white; width: 100%; min-height: 230px; background-color: #141414;"></textarea><br><br>
                        <label style="color: white;">Rate it!</label>
                        <select id="movie-rating" name="rating" autocomplete="off" style="display: none;">
                            <option value="1">Shit</option>
                            <option value="2">Very bad</option>
                            <option value="3">Bad</option>
                            <option value="4">Meh</option>
                            <option value="5" selected>Mediocre</option>
                            <option value="6">Alright</option>
                            <option value="7">Good</option>
                            <option value="8">Better than good</option>
                            <option value="9">Awesome</option>
                            <option value="10">Fucking awesome</option>
                        </select><br><br>
                    </div>
                </div>
               
            </div>
            <div class="modal-footer" style="border-top: 0px solid #8E8E8E;">
                <button type="button" class="btn fletnix-btn" style="padding: 10px; font-size: 16px; background-color: white;  color: black;" data-dismiss="modal">Close</button>
                <button type="button" class="btn fletnix-btn fletnix-red-background" style="padding: 10px; font-size: 16px; color: white;">Leave feedback</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/js/jquery-bar-rating.js" type="text/javascript"></script>
    <script>
        $(document).ready(function() {

            $(".movie").each(function(index) {
                getPoster($(this).data('id'), $('.movie-poster-' + $(this).data('id')), $(this).data('title'));
            });

            $('.feedback-box').click(function() {
                console.log($('.movie-poster-' + $(this).data('id')).attr('src'));
                getPoster(null, $('#feedbackposterimage'), $(this).data('title'), true);
                $('#mtitlefeedback').text($(this).data('title')+' ('+$(this).data('year')+')');
                $('#feedbackmodal').modal('toggle');
            });
            
            $(function() {
                $('#movie-rating').barrating({
                    theme: 'bars-movie'
                });
            });
        });

        function getPoster(id, element, title, poster) {
            if (poster == undefined) poster = false;
            $.get('https://api.themoviedb.org/3/search/movie?api_key=8f3879e8c91096e1e468cf6c539dc1e7&query=' +
                encodeURI(title),
                (res) => {
                    if (res.results[0]) {
                        if (res.results[0].backdrop_path) {
                            //poster_path
                            if (poster == false) {
                                element.attr('src', 'https://image.tmdb.org/t/p/w500/' + res.results[0].backdrop_path);
                            } else {
                                element.attr('src', 'https://image.tmdb.org/t/p/w500/' + res.results[0].poster_path);
                            }
                        }
                    } else {
                        element.attr('src', '/images/no-backdrop.jpg');
                    }
                });
        }
    </script>
}